#include <stdint.h>
#include "params.h"
#include "../common/randombytes.h"
#include "reduce.h"
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h> // 包含rand()函数的声明
#include "params.h"
#include "reduce.h"
#include <time.h>

//int16_t fq_inverse_table[CTRU_Q] = {
//    0, 1, 321, 214, 481, 513, 107, 458, 561, 285, 577, 408, 374, 148, 229, 171,
//    601, 264, 463, 135, 609, 580, 204, 223, 187, 359, 74, 95, 435, 420, 406, 579,
//    621, 136, 132, 348, 552, 52, 388, 263, 625, 172, 290, 164, 102, 57, 432, 491,
//    414, 157, 500, 88, 37, 254, 368, 338, 538, 45, 210, 402, 203, 620, 610, 407,
//    631, 286, 68, 354, 66, 288, 174, 316, 276, 281, 26, 547, 194, 333, 452, 284,
//    633, 459, 86, 502, 145, 181, 82, 140, 51, 605, 349, 479, 216, 193, 566, 27,
//    207, 152, 399, 259, 250, 476, 44, 585, 339, 116, 127, 6, 184, 247, 169, 231,
//    269, 312, 343, 301, 105, 515, 201, 404, 422, 445, 310, 271, 305, 200, 524, 106,
//    636, 482, 143, 504, 34, 294, 177, 19, 33, 510, 144, 558, 87, 591, 158, 130,
//    138, 84, 461, 266, 13, 413, 594, 433, 97, 243, 487, 244, 226, 49, 142, 512,
//    637, 215, 550, 350, 43, 540, 251, 380, 393, 110, 411, 15, 41, 352, 70, 326,
//    346, 134, 623, 265, 495, 85, 560, 634, 108, 395, 417, 24, 283, 563, 334, 443,
//    424, 93, 76, 309, 520, 423, 450, 335, 125, 118, 238, 60, 22, 419, 613, 96,
//    490, 595, 58, 240, 384, 319, 3, 161, 92, 449, 444, 521, 405, 612, 436, 23,
//    455, 396, 156, 593, 492, 14, 471, 111, 373, 630, 578, 611, 421, 522, 202, 582,
//    211, 258, 543, 153, 155, 416, 456, 109, 473, 381, 100, 166, 262, 603, 53, 274,
//    318, 429, 241, 99, 392, 474, 252, 39, 17, 179, 147, 629, 409, 112, 330, 123,
//    337, 587, 255, 324, 72, 361, 279, 278, 364, 73, 616, 188, 79, 9, 65, 574,
//    69, 468, 42, 478, 551, 606, 133, 465, 327, 300, 527, 313, 297, 115, 537, 586,
//    369, 124, 442, 451, 564, 195, 122, 371, 113, 299, 345, 466, 71, 366, 256, 213,
//    639, 2, 428, 385, 275, 570, 175, 296, 342, 528, 270, 519, 446, 77, 190, 199,
//    517, 272, 55, 104, 526, 344, 328, 114, 341, 314, 176, 508, 35, 90, 163, 599,
//    173, 572, 67, 576, 632, 562, 453, 25, 568, 277, 363, 362, 280, 569, 317, 386,
//    54, 304, 518, 311, 529, 232, 12, 494, 462, 624, 602, 389, 167, 249, 542, 400,
//    212, 323, 367, 588, 38, 379, 475, 541, 260, 168, 532, 185, 225, 486, 488, 98,
//    383, 430, 59, 439, 119, 220, 30, 63, 11, 268, 530, 170, 627, 149, 48, 485,
//    245, 186, 618, 205, 29, 236, 120, 197, 192, 549, 480, 638, 322, 257, 401, 583,
//    46, 151, 545, 28, 222, 619, 581, 403, 523, 516, 306, 191, 218, 121, 332, 565,
//    548, 217, 198, 307, 78, 358, 617, 224, 246, 533, 7, 81, 556, 146, 376, 18,
//    507, 295, 315, 571, 289, 600, 626, 230, 531, 248, 261, 390, 101, 598, 291, 91,
//    426, 4, 129, 499, 592, 415, 397, 154, 398, 544, 208, 47, 228, 628, 375, 180,
//    557, 503, 511, 483, 50, 554, 83, 497, 131, 608, 622, 464, 347, 607, 137, 498,
//    159, 5, 535, 117, 441, 336, 370, 331, 196, 219, 237, 440, 126, 536, 340, 298,
//    329, 372, 410, 472, 394, 457, 635, 514, 525, 302, 56, 597, 165, 391, 382, 242,
//    489, 434, 614, 75, 448, 425, 162, 292, 36, 590, 501, 559, 460, 496, 139, 555,
//    182, 8, 357, 189, 308, 447, 94, 615, 360, 365, 325, 467, 353, 575, 287, 573,
//    355, 10, 234, 31, 21, 438, 239, 431, 596, 103, 303, 273, 387, 604, 553, 141,
//    484, 227, 150, 209, 584, 539, 477, 351, 469, 16, 378, 253, 589, 89, 293, 509,
//    505, 20, 62, 235, 221, 206, 546, 567, 282, 454, 418, 437, 61, 32, 506, 178,
//    377, 40, 470, 412, 493, 267, 233, 64, 356, 80, 183, 534, 128, 160, 427, 320,
//    640};


int16_t fq_inverse_table[CTRU_Q] = {
        0, 1, 385, 513, 577, 154, 641, 110, 673, 171, 77, 70, 705, 355, 55, 564, 721,
        181, 470, 81, 423, 293, 35, 535, 737, 646, 562, 57, 412, 716, 282, 645, 745,
        536, 475, 22, 235, 291, 425, 631, 596, 694, 531, 465, 402, 188, 652, 180, 753,
        565, 323, 573, 281, 740, 413, 14, 206, 27, 358, 378, 141, 353, 707, 354, 757,
        71, 268, 264, 622, 691, 11, 65, 502, 611, 530, 728, 597, 10, 700, 623, 298, 19,
        347, 454, 650, 190, 617, 495, 201, 553, 94, 600, 326, 215, 90, 170, 761, 111,
        667, 435, 546, 434, 671, 112, 525, 520, 370, 115, 591, 127, 7, 97, 103, 245,
        398, 107, 179, 723, 189, 685, 455, 286, 561, 744, 738, 283, 177, 109, 763,
        155, 420, 317, 134, 451, 132, 319, 311, 595, 730, 426, 390, 60, 417, 242, 251,
        297, 690, 701, 265, 160, 364, 494, 683, 191, 5, 129, 350, 529, 696, 503, 149,
        406, 394, 184, 558, 261, 227, 571, 325, 678, 95, 9, 693, 729, 632, 312, 485,
        126, 661, 116, 47, 17, 300, 374, 163, 212, 492, 366, 45, 118, 85, 153, 765, 514,
        440, 280, 718, 324, 602, 228, 273, 88, 217, 322, 720, 754, 56, 743, 647, 287,
        260, 605, 185, 278, 442, 93, 680, 202, 448, 460, 388, 428, 433, 669, 436, 499, 507,
        166, 199, 497, 438, 516, 474, 736, 746, 36, 479, 464, 727, 695, 612, 351, 143, 519,
        665, 113, 372, 302, 369, 664, 526, 144, 473, 538, 439, 576, 766, 386, 462, 481, 210,
        165, 543, 500, 67, 148, 610, 697, 66, 506, 544, 437, 540, 200, 682, 618, 365, 583, 213,
        328, 195, 52, 30, 125, 593, 313, 121, 209, 510, 463, 533, 37, 345, 21, 735, 537,
        517, 145, 80, 751, 182, 396, 247, 401, 726, 532, 480, 511, 387, 550, 449, 136, 175,
        285, 649, 686, 348, 131, 636, 135, 459, 551, 203, 50, 197, 168, 92, 555, 279, 575,
        515, 539, 498, 545, 670, 668, 547, 429, 339, 338, 432, 548, 389, 630, 731, 292, 749,
        82, 316, 639, 156, 241, 627, 61, 63, 13, 715, 741, 58, 392, 408, 409, 393, 608, 150,
        276, 187, 725, 466, 248, 106, 655, 246, 468, 183, 607, 407, 410, 59, 629, 427, 549,
        461, 512, 767, 2, 257, 308, 220, 342, 140, 710, 359, 362, 162, 586, 301, 523, 114,
        663, 521, 303, 44, 582, 493, 619, 161, 376, 360, 361, 377, 711, 28, 54, 756, 706,
        708, 142, 528, 613, 130, 453, 687, 20, 477, 38, 139, 380, 221, 337, 431, 430, 340,
        222, 101, 99, 224, 271, 230, 254, 194, 490, 214, 677, 601, 572, 719, 566, 218, 310,
        634, 133, 638, 421, 83, 120, 484, 594, 633, 320, 219, 382, 258, 289, 237, 43, 368,
        522, 373, 587, 18, 689, 624, 252, 232, 34, 748, 424, 732, 236, 306, 259, 560, 648,
        456, 176, 644, 739, 717, 574, 441, 556, 186, 404, 151, 87, 569, 229, 332, 225, 263, 703,
        72, 159, 621, 702, 269, 226, 604, 559, 288, 307, 383, 3, 193, 330, 231, 296, 625, 243,
        105, 400, 467, 397, 656, 104, 250, 626, 418, 157, 74, 42, 305, 290, 733, 23, 33, 295,
        253, 331, 272, 570, 603, 262, 270, 333, 100, 336, 341, 381, 309, 321, 567, 89, 676,
        327, 491, 584, 164, 509, 482, 122, 26, 713, 15, 49, 447, 552, 681, 496, 541, 167, 445,
        51, 489, 329, 255, 4, 616, 684, 651, 724, 403, 277, 557, 606, 395, 469, 752, 722, 653,
        108, 643, 284, 457, 137, 40, 76, 760, 674, 91, 444, 198, 542, 508, 211, 585, 375, 363, 620,
        266, 73, 240, 419, 640, 764, 578, 86, 275, 405, 609, 504, 68, 79, 472, 518, 527, 352, 709,
        379, 343, 39, 174, 458, 450, 637, 318, 635, 452, 349, 614, 6, 660, 592, 486, 31, 25, 208,
        483, 314, 84, 580, 46, 590, 662, 371, 524, 666, 672, 762, 642, 178, 654, 399, 249, 244, 657,
        98, 335, 223, 334, 102, 658, 8, 599, 679, 554, 443, 169, 675, 216, 568, 274, 152, 579, 119,
        315, 422, 750, 471, 146, 69, 759, 172, 41, 239, 158, 267, 704, 758, 78, 147, 505, 501,
        698, 12, 415, 62, 416, 628, 391, 411, 742, 563, 755, 356, 29, 488, 196, 446, 204, 16, 589,
        117, 581, 367, 304, 238, 75, 173, 138, 344, 478, 534, 747, 294, 233, 24, 124, 487, 53, 357,
        712, 207, 123, 32, 234, 734, 476, 346, 688, 299, 588, 48, 205, 714, 414, 64, 699, 692, 598,
        96, 659, 128, 615, 192, 256, 384, 768};

int16_t montgomery_reduce(int32_t a)
{
  int32_t t;
  int16_t u;

  u = a * QINV;
  t = (int32_t)u * CTRU_Q;
  t = a - t;
  t >>= 16;
  return t;
}

int16_t barrett_reduce(int16_t a)
{
  int32_t t;

  t = BARRETT_V * (int32_t)a;
  t >>= 24;
  t *= CTRU_Q;
  return a - t;
}

int16_t fqcsubq(int16_t a)
{
  a += (a >> 15) & CTRU_Q;
  a -= CTRU_Q;
  a += (a >> 15) & CTRU_Q;
  return a;
}
int16_t fqinv(int16_t a)
{
  unsigned int i;
  int16_t t;

  t = 1;
  for (i = 1; i <= CTRU_Q - 2; ++i)
  {
   //  t = fqmul(t, a);
    t = (int32_t)t*(int32_t)a % CTRU_Q;
  }
  return t;
}
int16_t fqmul(int16_t a, int16_t b)
{
  return montgomery_reduce((int32_t)a * b);
}

int16_t fquniform()
{
  int16_t r;
  do
  {
    randombytes((unsigned char *)&r, 2);
    r &= 0x3FF;
  } while (r >= CTRU_Q);

  return r;
}
// #define BIG_INTEGER 10000000
// //主函数编译命令：gcc -o reduce_c reduce.c -lsodium
// int main() {
//     clock_t start, end;
//     double cpu_time_used;
//     int32_t *array = malloc(BIG_INTEGER * sizeof(int32_t)); // 创建一个包含1024个元素的数组
//     int16_t *reduced_array = malloc(BIG_INTEGER * sizeof(int16_t)); // 创建一个同样大小的int16_t类型数组来存储蒙哥马利减法的结果
//     if (array == NULL || reduced_array == NULL) {
//         fprintf(stderr, "Memory allocation failed!\n");
//         return 1;
//     }
//     // 生成1024个随机数填充数组
//     for (int i = 0; i < BIG_INTEGER; ++i) {
//         array[i] = (int32_t)(rand() % 10000); // 使用rand()函数填充数组
//     }

//     start = clock(); // 开始计时
//     // 对数组中的每个元素执行蒙哥马利减法
//     for (int i = 0; i < BIG_INTEGER; ++i) {
//       reduced_array[i] = montgomery_reduce(array[i]); // 注意：这里假设数组中的每个元素都是int32_t类型
//     }
    

//     end = clock(); // 结束计时
//     cpu_time_used = ((double) (end - start) * 1000 ) / CLOCKS_PER_SEC; // 计算执行时间

//     // 输出结果的前十个元素
//     printf("Montgomery reduced array (first 10 elements):\n");
//     for (int i = 0; i < 10; ++i) {
//         printf("%d ", reduced_array[i]);
//     }
//     printf("\n");
//     // 输出执行时间
//     printf("Time taken: %f mseconds\n", cpu_time_used);

//     return 0;
// }
