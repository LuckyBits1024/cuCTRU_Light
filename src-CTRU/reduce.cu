#include <stdint.h>
#include "params.h"
#include "randombytes.cuh"
#include "reduce.cuh"


__device__ int16_t fq_inverse_table[CTRU_Q] = {
        0, 1, 385, 513, 577, 154, 641, 110, 673, 171, 77, 70, 705, 355, 55, 564, 721,
        181, 470, 81, 423, 293, 35, 535, 737, 646, 562, 57, 412, 716, 282, 645, 745,
        536, 475, 22, 235, 291, 425, 631, 596, 694, 531, 465, 402, 188, 652, 180, 753,
        565, 323, 573, 281, 740, 413, 14, 206, 27, 358, 378, 141, 353, 707, 354, 757,
        71, 268, 264, 622, 691, 11, 65, 502, 611, 530, 728, 597, 10, 700, 623, 298, 19,
        347, 454, 650, 190, 617, 495, 201, 553, 94, 600, 326, 215, 90, 170, 761, 111,
        667, 435, 546, 434, 671, 112, 525, 520, 370, 115, 591, 127, 7, 97, 103, 245,
        398, 107, 179, 723, 189, 685, 455, 286, 561, 744, 738, 283, 177, 109, 763,
        155, 420, 317, 134, 451, 132, 319, 311, 595, 730, 426, 390, 60, 417, 242, 251,
        297, 690, 701, 265, 160, 364, 494, 683, 191, 5, 129, 350, 529, 696, 503, 149,
        406, 394, 184, 558, 261, 227, 571, 325, 678, 95, 9, 693, 729, 632, 312, 485,
        126, 661, 116, 47, 17, 300, 374, 163, 212, 492, 366, 45, 118, 85, 153, 765, 514,
        440, 280, 718, 324, 602, 228, 273, 88, 217, 322, 720, 754, 56, 743, 647, 287,
        260, 605, 185, 278, 442, 93, 680, 202, 448, 460, 388, 428, 433, 669, 436, 499, 507,
        166, 199, 497, 438, 516, 474, 736, 746, 36, 479, 464, 727, 695, 612, 351, 143, 519,
        665, 113, 372, 302, 369, 664, 526, 144, 473, 538, 439, 576, 766, 386, 462, 481, 210,
        165, 543, 500, 67, 148, 610, 697, 66, 506, 544, 437, 540, 200, 682, 618, 365, 583, 213,
        328, 195, 52, 30, 125, 593, 313, 121, 209, 510, 463, 533, 37, 345, 21, 735, 537,
        517, 145, 80, 751, 182, 396, 247, 401, 726, 532, 480, 511, 387, 550, 449, 136, 175,
        285, 649, 686, 348, 131, 636, 135, 459, 551, 203, 50, 197, 168, 92, 555, 279, 575,
        515, 539, 498, 545, 670, 668, 547, 429, 339, 338, 432, 548, 389, 630, 731, 292, 749,
        82, 316, 639, 156, 241, 627, 61, 63, 13, 715, 741, 58, 392, 408, 409, 393, 608, 150,
        276, 187, 725, 466, 248, 106, 655, 246, 468, 183, 607, 407, 410, 59, 629, 427, 549,
        461, 512, 767, 2, 257, 308, 220, 342, 140, 710, 359, 362, 162, 586, 301, 523, 114,
        663, 521, 303, 44, 582, 493, 619, 161, 376, 360, 361, 377, 711, 28, 54, 756, 706,
        708, 142, 528, 613, 130, 453, 687, 20, 477, 38, 139, 380, 221, 337, 431, 430, 340,
        222, 101, 99, 224, 271, 230, 254, 194, 490, 214, 677, 601, 572, 719, 566, 218, 310,
        634, 133, 638, 421, 83, 120, 484, 594, 633, 320, 219, 382, 258, 289, 237, 43, 368,
        522, 373, 587, 18, 689, 624, 252, 232, 34, 748, 424, 732, 236, 306, 259, 560, 648,
        456, 176, 644, 739, 717, 574, 441, 556, 186, 404, 151, 87, 569, 229, 332, 225, 263, 703,
        72, 159, 621, 702, 269, 226, 604, 559, 288, 307, 383, 3, 193, 330, 231, 296, 625, 243,
        105, 400, 467, 397, 656, 104, 250, 626, 418, 157, 74, 42, 305, 290, 733, 23, 33, 295,
        253, 331, 272, 570, 603, 262, 270, 333, 100, 336, 341, 381, 309, 321, 567, 89, 676,
        327, 491, 584, 164, 509, 482, 122, 26, 713, 15, 49, 447, 552, 681, 496, 541, 167, 445,
        51, 489, 329, 255, 4, 616, 684, 651, 724, 403, 277, 557, 606, 395, 469, 752, 722, 653,
        108, 643, 284, 457, 137, 40, 76, 760, 674, 91, 444, 198, 542, 508, 211, 585, 375, 363, 620,
        266, 73, 240, 419, 640, 764, 578, 86, 275, 405, 609, 504, 68, 79, 472, 518, 527, 352, 709,
        379, 343, 39, 174, 458, 450, 637, 318, 635, 452, 349, 614, 6, 660, 592, 486, 31, 25, 208,
        483, 314, 84, 580, 46, 590, 662, 371, 524, 666, 672, 762, 642, 178, 654, 399, 249, 244, 657,
        98, 335, 223, 334, 102, 658, 8, 599, 679, 554, 443, 169, 675, 216, 568, 274, 152, 579, 119,
        315, 422, 750, 471, 146, 69, 759, 172, 41, 239, 158, 267, 704, 758, 78, 147, 505, 501,
        698, 12, 415, 62, 416, 628, 391, 411, 742, 563, 755, 356, 29, 488, 196, 446, 204, 16, 589,
        117, 581, 367, 304, 238, 75, 173, 138, 344, 478, 534, 747, 294, 233, 24, 124, 487, 53, 357,
        712, 207, 123, 32, 234, 734, 476, 346, 688, 299, 588, 48, 205, 714, 414, 64, 699, 692, 598,
        96, 659, 128, 615, 192, 256, 384, 768};

__device__ int16_t montgomery_reduce(int32_t a)
{
  int32_t t;
  int16_t u;
  u = a * QINV;
  t = (int32_t)u * CTRU_Q;
  t = a - t;
  t >>= 16;
  return t;
}

__device__ int16_t barrett_reduce(int16_t a)
{
  int32_t t;
  t = BARRETT_V * (int32_t)a;
  t >>= 24;
  t *= CTRU_Q;
  return a - t;
}

// 用来把系数规范到 [0, CTRU_Q)
__device__ int16_t fqcsubq(int16_t a)
{
  a += (a >> 15) & CTRU_Q;
  a -= CTRU_Q;
  a += (a >> 15) & CTRU_Q;
  return a;
}
__device__ int16_t fqinv(int16_t a)
{
  unsigned int i;
  int16_t t;

  t = 1;
  for (i = 1; i <= CTRU_Q - 2; ++i)
  {
   //  t = fqmul(t, a);
    t = (int32_t)t*(int32_t)a % CTRU_Q;
  }
  return t;
}
__device__ int16_t fqmul(int16_t a, int16_t b)
{
  return montgomery_reduce((int32_t)a * b);
}

__host__ int16_t fquniform()
{
  int16_t r;
  do
  {
    randombytes((unsigned char *)&r, 2);
    r &= 0x3FF;
  } while (r >= CTRU_Q);

  return r;
}
